<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      :root {
        --bg: #0b1118;
        --panel: #121a24;
        --muted: #8aa0b6;
        --fg: #e8f1fb;
        --border: #1f2a36;
        --accent: #7dd3fc;
        --ok: #22c55e;
        --warn: #f59e0b;
        --err: #ef4444;
        --chip: #1a2532;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: Inter, system-ui, Arial;
      }
      header {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        position: sticky;
        top: 0;
        background: linear-gradient(
          180deg,
          rgba(11, 17, 24, 0.9),
          rgba(11, 17, 24, 0.6)
        );
        backdrop-filter: blur(6px);
        z-index: 9;
      }
      header .dot {
        width: 10px;
        height: 10px;
        background: var(--accent);
        border-radius: 999px;
        box-shadow: 0 0 10px rgba(125, 211, 252, 0.6);
      }
      .wrap {
        max-width: 1200px;
        margin: 0 auto;
        padding: 18px;
      }
      .toolbar {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 14px;
      }
      .toolbar .group {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      select,
      input[type="text"] {
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--fg);
        padding: 8px 10px;
        border-radius: 10px;
        outline: none;
      }
      label {
        color: var(--muted);
        font-size: 13px;
      }
      .grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(12, 1fr);
      }
      .card {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
      }
      .span-3 {
        grid-column: span 3;
      }
      .span-4 {
        grid-column: span 4;
      }
      .span-5 {
        grid-column: span 5;
      }
      .span-6 {
        grid-column: span 6;
      }
      .span-7 {
        grid-column: span 7;
      }
      .span-8 {
        grid-column: span 8;
      }
      .span-12 {
        grid-column: span 12;
      }
      h2 {
        font-size: 15px;
        margin: 0 0 10px;
        color: #cfe1f5;
      }
      .kpis {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }
      .kpi {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .kpi .value {
        font-size: 28px;
        font-weight: 600;
      }
      .kpi .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .chip {
        background: var(--chip);
        border: 1px solid var(--border);
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        color: #cfe1f5;
      }
      .status-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 999px;
        margin-right: 6px;
      }
      .s-2xx {
        background: var(--ok);
      }
      .s-4xx {
        background: var(--warn);
      }
      .s-5xx {
        background: var(--err);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th,
      td {
        padding: 10px;
        border-bottom: 1px solid var(--border);
      }
      th {
        color: #9bb3cc;
        text-align: left;
        user-select: none;
      }
      tr:hover td {
        background: rgba(125, 211, 252, 0.04);
      }
      .tight td {
        padding: 8px;
      }
      .right {
        text-align: right;
      }
      .muted {
        color: var(--muted);
      }
      .pill {
        padding: 2px 8px;
        border-radius: 999px;
        background: #0e1620;
        border: 1px solid var(--border);
        font-size: 12px;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .mini {
        font-size: 12px;
        color: var(--muted);
      }
      .footer {
        padding: 22px 0;
        color: var(--muted);
        font-size: 12px;
        text-align: center;
      }
      .btn {
        background: var(--panel);
        border: 1px solid var(--border);
        color: var(--fg);
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
      }
      .btn:active {
        transform: translateY(1px);
      }
      @media (max-width: 900px) {
        .span-8,
        .span-7,
        .span-6,
        .span-5,
        .span-4,
        .span-3 {
          grid-column: span 12;
        }
        .kpis {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="dot"></div>
      <div style="font-weight: 600">Express Analytics</div>
      <div id="latency" class="mini"></div>
      <div style="margin-left: auto" class="mini" id="last-updated"></div>
    </header>

    <div class="wrap">
      <!-- Settings / filters -->
      <div class="toolbar">
        <div class="group">
          <label>Window</label>
          <select id="window">
            <option>24 hours</option>
            <option>7 days</option>
            <option>30 days</option>
          </select>
        </div>
        <div class="group">
          <label>Bucket</label>
          <select id="bucket">
            <option>hour</option>
            <option>minute</option>
            <option>day</option>
          </select>
        </div>
        <div class="group">
          <label>Filter</label>
          <input id="filter" type="text" placeholder="route or ip contains…" />
        </div>
        <div class="group">
          <label>Auto-refresh</label>
          <select id="refresh">
            <option value="0">Off</option>
            <option value="10">10s</option>
            <option value="30" selected>30s</option>
            <option value="60">60s</option>
          </select>
          <button id="reload" class="btn">Reload</button>
        </div>
      </div>

      <div class="grid">
        <!-- KPI cards -->
        <div class="card span-4">
          <h2>30-day Requests</h2>
          <div class="kpis">
            <div class="kpi">
              <div class="value" id="kpi-total">–</div>
              <div class="chips" id="status-chips"></div>
            </div>
          </div>
        </div>

        <div class="card span-8">
          <h2>Traffic</h2>
          <canvas id="traffic"></canvas>
        </div>

        <div class="card span-6">
          <div class="row">
            <h2>Top Routes (24h)</h2>
            <button class="btn" id="copy-routes">Copy</button>
          </div>
          <table id="routes" class="tight">
            <thead>
              <tr>
                <th data-sort="route">Route</th>
                <th class="right" data-sort="c">Hits</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card span-6">
          <div class="row">
            <h2>Top IPs (24h)</h2>
            <button class="btn" id="copy-ips">Copy</button>
          </div>
          <table id="ips" class="tight">
            <thead>
              <tr>
                <th data-sort="ip">IP</th>
                <th class="right" data-sort="c">Hits</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="card span-12">
          <div class="row" style="justify-content: space-between">
            <h2>Recent Requests</h2>
            <div class="mini muted" id="recent-count"></div>
          </div>
          <table id="recent">
            <thead>
              <tr>
                <th data-sort="occurred_at">Time</th>
                <th data-sort="method">M</th>
                <th data-sort="route">Route</th>
                <th data-sort="status">S</th>
                <th data-sort="latency_ms">ms</th>
                <th data-sort="ip">IP</th>
                <th>User-Agent</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="footer">
        Built-in dashboard • auto-refresh, sorting, filtering • IPv4-mapped IPv6
        cleaned
      </div>
    </div>

    <script>
      // ---------- helpers ----------
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const j = async (u) => {
        const r = await fetch(u);
        if (!r.ok) throw new Error(await r.text());
        return r.json();
      };
      const fmtNum = (n) => (n ?? 0).toLocaleString();
      const unmapIp = (ip) =>
        ip && ip.startsWith("::ffff:") ? ip.slice(7) : ip;

      let trafficChart;
      function ensureChart(ctx, labels, data) {
        if (trafficChart) trafficChart.destroy();
        trafficChart = new Chart(ctx, {
          type: "line",
          data: { labels, datasets: [{ label: "Requests", data }] },
          options: {
            responsive: true,
            plugins: { legend: { display: false } },
            interaction: { mode: "index", intersect: false },
          },
        });
      }

      function sortTable(table, key, desc = false) {
        const tbody = table.tBodies[0];
        const rows = Array.from(tbody.rows);
        const idx = Array.from(table.tHead.rows[0].cells).findIndex(
          (c) => c.dataset.sort === key
        );
        rows.sort((a, b) => {
          const va = a.cells[idx].dataset.value ?? a.cells[idx].textContent;
          const vb = b.cells[idx].dataset.value ?? b.cells[idx].textContent;
          const na = Number(va),
            nb = Number(vb);
          const cmp =
            !isNaN(na) && !isNaN(nb)
              ? na - nb
              : String(va).localeCompare(String(vb));
          return desc ? -cmp : cmp;
        });
        rows.forEach((r) => tbody.appendChild(r));
      }

      // ---------- state ----------
      let refreshTimer = null;
      function setAutoRefresh(seconds) {
        if (refreshTimer) clearInterval(refreshTimer);
        if (Number(seconds) > 0)
          refreshTimer = setInterval(loadAll, Number(seconds) * 1000);
      }

      // ---------- data loaders ----------
      async function loadAll() {
        const windowSel = $("#window").value;
        const bucketSel = $("#bucket").value;

        const [summary, traffic, routes, ips, recent] = await Promise.all([
          j("/api/summary"),
          j(
            `/api/traffic?window=${encodeURIComponent(
              windowSel
            )}&bucket=${encodeURIComponent(bucketSel)}`
          ),
          j("/api/top-routes"),
          j("/api/top-ips"),
          j("/api/recent"),
        ]);

        // KPIs
        $("#kpi-total").textContent = fmtNum(summary.total_30d || 0);
        $("#status-chips").innerHTML = (summary.statuses || [])
          .map((s) => {
            let cls = "";
            const n = Number(s.status || 0);
            if (n >= 500) cls = "s-5xx";
            else if (n >= 400) cls = "s-4xx";
            else cls = "s-2xx";
            return `<span class="chip"><span class="status-dot ${cls}"></span>${
              s.status || "–"
            }: ${fmtNum(s.c)}</span>`;
          })
          .join(" ");
        const lat = summary.latency || {};
        $("#latency").textContent = `p50 ${Math.round(
          lat.p50 || 0
        )}ms • p95 ${Math.round(lat.p95 || 0)}ms • p99 ${Math.round(
          lat.p99 || 0
        )}ms`;
        $(
          "#last-updated"
        ).textContent = `Updated ${new Date().toLocaleTimeString()}`;

        // Traffic chart
        const labels = (traffic || []).map((r) =>
          new Date(r.t).toLocaleString()
        );
        const data = (traffic || []).map((r) => r.c);
        ensureChart($("#traffic").getContext("2d"), labels, data);

        // Tables
        const routesT = $("#routes tbody");
        routesT.innerHTML = (routes || [])
          .map(
            (r) =>
              `<tr><td>${r.route || "/"}</td><td class="right" data-value="${
                r.c
              }">${fmtNum(r.c)}</td></tr>`
          )
          .join("");

        const ipsT = $("#ips tbody");
        ipsT.innerHTML = (ips || [])
          .map((r) => {
            const ip = unmapIp(r.ip || "");
            return `<tr><td>${ip}</td><td class="right" data-value="${
              r.c
            }">${fmtNum(r.c)}</td></tr>`;
          })
          .join("");

        const filterVal = $("#filter").value.trim().toLowerCase();
        const recT = $("#recent tbody");
        const filtered = (recent || []).filter((r) => {
          if (!filterVal) return true;
          const ip = unmapIp(r.ip_full || r.ip_cidr || "");
          return (
            (r.route || "").toLowerCase().includes(filterVal) ||
            ip.toLowerCase().includes(filterVal)
          );
        });

        recT.innerHTML = filtered
          .map((r) => {
            const ip = unmapIp(r.ip_full || r.ip_cidr || "");
            const s = Number(r.status || 0);
            const cls = s >= 500 ? "s-5xx" : s >= 400 ? "s-4xx" : "s-2xx";
            return `<tr>
        <td data-value="${Date.parse(r.occurred_at) || 0}">${new Date(
              r.occurred_at
            ).toLocaleTimeString()}</td>
        <td>${r.method || ""}</td>
        <td>${r.route || ""}</td>
        <td class="${cls}" data-value="${s}">${s || ""}</td>
        <td class="right" data-value="${r.latency_ms || 0}">${fmtNum(
              r.latency_ms || 0
            )}</td>
        <td>${ip}</td>
        <td class="muted">${(r.user_agent || "").slice(0, 80)}</td>
      </tr>`;
          })
          .join("");
        $("#recent-count").textContent = `${filtered.length} shown${
          filterVal ? ` • filtered by "${filterVal}"` : ""
        }`;
      }

      // ---------- events ----------
      $("#reload").addEventListener("click", loadAll);
      $("#refresh").addEventListener("change", (e) =>
        setAutoRefresh(e.target.value)
      );

      // column sorting
      $$("#routes thead th, #ips thead th, #recent thead th").forEach((th) => {
        let desc = false;
        th.addEventListener("click", () => {
          const table = th.closest("table");
          const key = th.dataset.sort;
          desc = !desc;
          sortTable(table, key, desc);
        });
      });

      // initial
      setAutoRefresh($("#refresh").value);
      loadAll().catch((err) => alert("Failed to load: " + err.message));
    </script>
  </body>
</html>
